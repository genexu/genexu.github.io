---
import { getCollection } from "astro:content";
import languages from "../../../i18n/languages";
import Layout from "../../../layouts/Layout.astro";
import SearchBar from "../../../components/SearchBar";
import BlogCard from "../../../components/BlogCard.astro";
import { deconstructSlug, getLangFromUrl, getPostsByLang } from "../../../i18n/utils";

export async function getStaticPaths() {
	const paths = Object.keys(languages).map((lang) => ({
		params: { lang },
	}));

	return paths;
}

const lang = getLangFromUrl(Astro.url);

const posts = await getCollection("blog");
const postsByLang = getPostsByLang(posts, lang);
postsByLang.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const decoratedPosts = postsByLang.map((post) => {
	const { slugWithoutLang } = deconstructSlug(post.slug);
	return {
		...post,
		params: {
			slug: slugWithoutLang,
			lang,
		},
	};
});

const content = {
	en: {
		title: "Blog Posts",
		description: "All articles and thoughts on web development, software engineering, and technology",
		searchPlaceholder: "Search posts...",
	},
	"zh-tw": {
		title: "所有文章",
		description: "關於網頁開發、軟體工程和技術的文章與想法",
		searchPlaceholder: "搜尋文章...",
	},
};

const t = content[lang] || content.en;
---

<Layout title={t.title} description={t.description}>
	<div class="py-8 md:py-12 space-y-8">
		<header class="max-w-3xl space-y-4">
			<h1 class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-white tracking-tight">
				{t.title}
			</h1>
			<p class="text-lg text-slate-600 dark:text-slate-300">
				{t.description}
			</p>
		</header>

		<div class="max-w-3xl">
			<SearchBar client:load />
		</div>

		<div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
			{decoratedPosts.map((post) => (
				<BlogCard post={post} />
			))}
		</div>

		{decoratedPosts.length === 0 && (
			<div class="text-center py-12">
				<p class="text-slate-500 dark:text-slate-400">No posts found</p>
			</div>
		)}
	</div>
</Layout>
