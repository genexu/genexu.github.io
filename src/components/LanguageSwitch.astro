---
import { Icon } from "astro-icon";
import { getRelativeLocaleUrl } from "astro:i18n";
import languages, { defaultLanguage } from "../i18n/languages";

const currentLanguage = Astro.currentLocale || defaultLanguage;
const pathname = Astro.url.pathname;

const label = (languages[currentLanguage] || languages[defaultLanguage]).shortname;
const languagekeys = Object.keys(languages);

// Get the next language in the list
const switchTargetLanguage = languagekeys[(languagekeys.indexOf(currentLanguage) + 1) % languagekeys.length];

// Extract the path without the locale prefix
// For /blog/post -> blog/post (no prefix for default locale)
// For /zh-tw/notes/note -> notes/note
const pathParts = pathname.split('/').filter(Boolean);
const firstPart = pathParts[0];
const isLocaleInPath = languagekeys.includes(firstPart);
const pathWithoutLocale = isLocaleInPath ? pathParts.slice(1).join('/') : pathParts.join('/');

// Generate the switch target URL using Astro's i18n helper
const switchTargetLocation = getRelativeLocaleUrl(switchTargetLanguage, pathWithoutLocale);
---

<button
	id="language-switch"
	class=`
		px-2 py-1
		flex items-center space-x-2
	 	border dark:border-white border-gray-900 rounded-lg
	 	cursor-pointer
	`
>
	<Icon pack="cil" name="language" width="16" height="16" />
	<span class="text-xs">{label}</span>
</button>

<script define:vars={{ switchTargetLocation }}>
const button = document.getElementById("language-switch");
button.addEventListener("click", () => (window.location.href = switchTargetLocation));
</script>
